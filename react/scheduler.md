# Scheduler调度器

在React16中，Scheduler是一种用于热舞调度的模块，它允许React在更新DOM时根据任务的优先级进行排序和执行。React通过优先级系统来决定那些任务应该优先执行，那些任务可以少执行。以下是如何在React16的Scheduler中判断任务优先级的简要描述：

## 优先级种类

React的Scheduler中定义了多种优先级，这些优先级用于区分不同类型的任务。常见的优先级包括：

- NoWork：无工等待处理，优先级为0.
- SynchronousPriority：同步优先级，用于控制文本输入等需要立即相应的交互，优先级为1。
- AnimationPriority：动画优先级，需要在下一帧之前完成，优先级为2。
- HigPriority：高优先级，用于需要尽快啊完成的交互，优先级为3。
- LowPriority： 低优先级，有用数据获取或更新存储等操作，优先级为4。
- OffscreenPriority: 屏幕外优先级，用于可能变得可简单当前不可见的元素，优先级为5。

## 优先级判断

Scheduler通过任务调度循环来确定任务的执行顺序。这个循环使用一个最小堆（二叉堆）作为数据结构，其中任务按照优先级进行排序。浏览器工作的每一帧中，React都会像浏览器申请时间（通常是5ms）来执行最小堆中的任务。

- 任务注册：当React需要行一个任务时（例如，由于状态更新或DOM事件），他会将任务注册到Scheduler中，并制定一个优先级。
- 任务排队：Scheduler将任务按照优先级放入最小堆中。最小堆确保对顶元素始终具有最高优先级
- 任务执行：在每一帧中，React从最小堆的定不去除任务执行。如果时间片用完或更高优先级的任务出现，当前任务可能会被中断。
- 中断与恢复：如果高优先级的人物出现，Scheduler会中断当前任务并立即执行高优先级任务。当高优先级任务完成后，Scheduler会回复之被中断的任务。

## 优先合并于拆分

在React内部，还是用了一种成为Lane模型的优先级系统，Lane模型使用二进制来表现优先级，通过位运算来合并和拆分优先级。这种机制允许React更精致地控制任务的优先级和调度。

## 总结

React16的Scheduler通过定义多种优先级并使用最小堆数据结构来判断和调度任务的执行顺序。通过优先级的设置和任务的排队，React能够确保中的交互和动画得到及时响应，同时优化非关键任务的执行。
